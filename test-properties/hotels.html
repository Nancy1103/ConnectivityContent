<script src="/js/jquery.DataTables.min.js"></script>
<script src="/js/dataTables.buttons.min.js"></script>
<style>
    .dataTables_length, .dataTables_filter {
        display: none;
    }

    .simple-content form {
        margin-top: 50px;
        margin-bottom: 200px;
    }
</style>
<div class="large-6 large-centered medium-10 medium-centered columns simple-content">
    <h1>EPC Hotels</h1>
    <p class="announce">
        Below is a list of hotels associated with your account.
    </p>
    <table id="hotels" class="display" cellspacing="0" width="100%"></table>
    <form id="requestHotelForm">
        <div id="result" class="formline center"></div>
        <div id="factors"></div>
        <div class="formline">
            <input class="submit" type="submit" value="Request Hotel"/>
        </div>
    </form>
</div>

<script>
    var datatable = false;
    var assignmentRequestFields = [];

    var columns = [
        { title: "TUID" },
        { title: "Hotel ID" },
        { title: "Name" },
        { title: "Valid From", type: "date" },
        { title: "Valid To", type: "date" },
        { title: "Model" },
        { title: "Currency" },
        { title: "Pricing" },
        { title: "RAT" }
    ];

    var buttons = [
        { text: "Unassign", action: unassign }
    ];

    $(document).ready(function() {
        datatable = $("#hotels").DataTable({
            dom: 'Bfrtip',
            columns: columns,
            buttons: buttons,
            pageLength: 100,
            ajax: function (data, callback, settings) {
                jwtRequest("GET", "http://hotel-assignment-service.us-west-2.test.expedia.com/v1/schedule", function(data, textStatus, jqxhr) {
                    console.log("Successful response for " + jqxhr.url + " : " + jqxhr.responseText);
                    $("#result").removeClass("error").text("");
                    callback({data: parseData(JSON.parse(jqxhr.responseText))});
                    datatable.order([ 3, "asc" ]).draw();
                }, function(jqxhr) {
                    ajaxError(jqxhr, "Could not lookup your scheduled test hotels.");
                });
            }
        }).on('click', 'tr', function() {
            if ($(this).hasClass("selected")) {
                $(this).removeClass("selected");
                $(".dt-button").prop("disabled", true).addClass("disabled");
                console.log("disabled");
            } else {
                $("#hotels tr").removeClass("selected");
                $(this).addClass("selected");
                $(".dt-button").prop("disabled", false).removeClass("disabled");
                console.log("enabled");
            }
        });

        $.getJSON("http://hotel-assignment-service.us-west-2.test.expedia.com/v1/hotels/factors", parseFactors);
        $(".dt-button").prop("disabled", true).addClass("disabled");
    });

    $('#requestHotelForm').submit(function (event) {
        event.preventDefault();
        autoAssignHotel();
    });

    function parseData(data) {
        var table = [];
        for (tuid of data) {
            for (hotel of tuid.hotels) {
                for (date of hotel.dates) {
                    table.push([tuid.tuid, hotel.hotelId, hotel.hotelName, date.startDate, date.endDate,
                                hotel.businessModel, hotel.currencyCode, hotel.pricingType, hotel.ratType]);
                }
            }
        }
        return table;
    }

    function parseFactors(factors) {
        var factorsLoc = $('#factors');
        for (var factor of factors) {
            var label = $('<label>').text(factor.displayName);
            var sel = $('<select>');
            sel.attr('id', "val_" + factor.factorName);
            sel.attr('name', factor.factorName);
            assignmentRequestFields.push(factor.factorName);
            sel.append($('<option selected>').attr('value', '').text('No preference'));
            for (var value of factor.validValues) {
                sel.append($('<option>').attr('value', value).text(value));
            }
            factorsLoc.append(label);
            factorsLoc.append(sel);
            factorsLoc.append($('<br/><br/>'));
        }
    }

    function ajaxError(jqxhr, humanError) {
        console.log("Error response for " + jqxhr.url + " : " + jqxhr.responseText);
        $("#result").addClass("error").text(humanError);
    }

    function addAssignmentField(request, fieldName) {
        var val = $('#val_' + fieldName).val();
        if (val != '') {
            request[fieldName] = val;
        }
    }

    function getAssignmentRequest() {
        var request = {};
        for (fieldName of assignmentRequestFields) {
            addAssignmentField(request, fieldName);
        }
        return request;
    }

    function autoAssignHotel() {
        var req = getAssignmentRequest();
        jwtRequestWithData("POST", "http://hotel-assignment-service.us-west-2.test.expedia.com/v1/schedule/assign", req, function(data, textStatus, jqxhr) {
            console.log("Successful response for " + jqxhr.url + " : " + jqxhr.responseText);
            $("#result").removeClass("error").text("Successfully assigned hotel");
            datatable.ajax.reload();
        }, function(jqxhr) {
            ajaxError(jqxhr, "Could not schedule a test hotel.");
        });
    }

    function unassign(e, dt, node, config) {
        console.log("unassign");
        var hotelid = dt.cell(".selected", 1).data();
        jwtRequest("DELETE", "http://hotel-assignment-service.us-west-2.test.expedia.com/v1/schedule/hotelId/" + hotelid, function(data, textStatus, jqxhr) {
            console.log("Successful response for " + jqxhr.url + " : " + jqxhr.responseText);
            $("#result").removeClass("error").text("Successfully unassigned hotel");
            datatable.ajax.reload();
        }, function(jqxhr) {
            ajaxError(jqxhr, "Could not unassign a test hotel.");
        });
    }


</script>