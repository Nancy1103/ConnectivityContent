<div class="large-6 large-centered medium-10 medium-centered columns simple-content">
    <h1>EPC Hotels</h1>
    <p class="announce">
        Below is a list of hotels associated with your account.
    </p>
    <table id="hotels" style="display: none;" class="display" cellspacing="0" width="100%"></table>
    <form style="margin-bottom: 200px;" onsubmit="return false;">
        <div id="result" class="formline center"></div>
        <div class="formline"><input class="submit" type="button" value="Request Hotel" onclick="autoAssignHotel();"/>
        </div>
    </form>
</div>

<script>
    var datatable = false;

    var columns = [
        { title: "TUID" },
        { title: "Hotel ID" },
        { title: "Name" },
        { title: "Valid From", type: "date" },
        { title: "Valid To", type: "date" },
        { title: "Model" },
        { title: "Currency" },
        { title: "Pricing" },
        { title: "RAT" }
    ];

    $(document).ready(function() {
        getHotelsByJwt();
    });

    function jwtRequest(method, url, done, error) {
        $.ajax({
            method: method,
            url: url,
            xhrFields: {
                withCredentials: true,
                XDomainRequest: true
            },
            beforeSend: function(xhr) {
                xhr.setRequestHeader("Authorization", "Bearer " + localStorage.getItem("AuthToken"));
            }
        }).done(done).fail(error);
    }

    function displayTable(data) {
        var table = [];
        for (tuid of data) {
            for (hotel of tuid.hotels) {
                for (date of hotel.dates) {
                    table.push([tuid.tuid, hotel.hotelId, hotel.hotelName, date.startDate, date.endDate,
                                hotel.businessModel, hotel.currencyCode, hotel.pricingType, hotel.ratType]);
                }
            }
        }
        if (datatable) {
            datatable.destroy();
        }
        datatable = $("#hotels").DataTable({ data: table, columns: columns });
        datatable.order([ 2, "asc" ]).draw();
        $("#hotels").show();
    }

    function ajaxError(jqxhr, humanError) {
        console.log("Error response for " + jqxhr.url + " : " + jqxhr.responseText);
        $("#result").addClass("error").text(humanError);
    }

    function getHotelsByJwt() {
        jwtRequest("GET", "http://test-property-service.us-west-2.test.expedia.com/v1/schedule", function(data, textStatus, jqxhr) {
            console.log("Successful response for " + jqxhr.url + " : " + jqxhr.responseText);
            $("#result").removeClass("error").text("");
            displayTable(JSON.parse(jqxhr.responseText));
        }, function(jqxhr) {
            ajaxError(jqxhr, "Could not lookup your scheduled test hotels.");
        });
    }

    function autoAssignHotel() {
        jwtRequest("POST", "http://test-property-service.us-west-2.test.expedia.com/v1/schedule/assign", function(data, textStatus, jqxhr) {
            console.log("Successful response for " + jqxhr.url + " : " + jqxhr.responseText);
            $("#result").removeClass("error").text("Successfully assigned hotel");
            getHotelsByJwt();
        }, function(jqxhr) {
            ajaxError(jqxhr, "Could not schedule a test hotel.");
        });
    }


</script>