# Understanding Expedia Lodging Data Model
In the Expedia lodging data model, properties, room types and rate plans are stored according to the following hierarchy:
- Each property has 0 or more room types
- Each room type has one or more rate plans
- Each rate plan belongs to a single room type
- Each rate plan is associated with a single cancellation policy and a single set of additional guest amounts.
The Product API enables partners to first create a room type, and subsequently create rate plans for that room type. For every room type created, the partner is expected to add rate plans to it even if the system will not enforce this rule automatically.

# API Principles & Standards

- **JSON** : The service will return JSON documents for read, create, and update requests, and accept JSON payloads for create and update requests.
- **Secure HTTP** : The API is available via HTTPS, and supports GET (read), POST (create), and PUT (update) operations.
- **REST** : The service adheres to REST principles and exposes three resources: Rate Plans, Room Types, and Properties.
- **HTTP Status Code** : The API will leverage HTTP status codes as defined by RFC 2616, Section 10. More specifically, users should expect the following from the API: 

| Status Code | Meaning |
| ----------- | ------- |
| 200 | Success for read and update operations |
| 201 | Success for create operations |
| 400 | Errors induced by user due to incorrect input |
| 401 | Authentication error |
| 403 | Authorization error |
| 404 | Invalid resource |
| 405 | Invalid/unsupported method on resource |
| 406 | Unsupported media type for response (only JSON supported) |
| 409 | Conflicting data |
| 415 | Unsupported media type (only JSON supported) |
| 500 | Internal system error (shouldn’t be retried) |
| 503 | Internal system error (should be retried, following logic specified in HTTP response header) |
- **MUST-IGNORE** : The service is constantly evolving and we expect consumers of our service to enforce a must-ignore policy. If the Product API starts returning additional data elements in responses, partners should ignore the data elements they do not need. 
- **Entity** : All responses returned by EPS services are encapsulated within an HTTP Entity. Entity is used as a way to make responses generic across different operations. The Entity element may represent a single object, or multiple objects; if the latter, it would be an array. When partners integrate with our APIs, in most cases, they will use serialization/deserialization to deal with messages natively, using the programming language of their choice. 
- **Errors** : Alternatively, if the request produces errors, the response will return an array of one or more errors. If Errors are present, Entity will not be present.

# HTTP Headers
## Format – Request
| Header | Type | Required | Input Format |
| ------ | ---- | -------- | ------------ |
| Authorization | String | Required | Authorization: Basic <username:password encoded by Base64> |
| Content-Type | String | Required* | Content-Type: application/json |
| Accept | String | Required | Accept: application/json |
| Request-ID | String | Optional | Request-ID: UUID This request ID can be provided by the partner and can be referenced later on for troubleshooting purposes. If it is not provided in request, API will generate one and return it in the response. If provided, API will return the same header in the response. |
*required for create and modify requests only

## Format – Response
| Header | Type | Input Format |
| ------ | ---- | ------------ |
| Content-Type | String | Content-Type: application/json |
| Request-ID | String | Partner-provided request identifier. If provided in the request, will be returned in the response |
| Transaction-ID | GUID | Unique transaction ID generated by Expedia for all messages. Expedia recommends storing this identifier. Can be used to reference messages when troubleshooting with Expedia. |

# Basic response structure with Entity and Errors
All responses provided by the API will either contain an HTTP Entity element, which may represent a single object or an array of objects, or an Errors object for an array of errors. 

## Entity
The entities we support with this API are room type, rate plan and property. These will be described in details in subsequent sections.

The Entity approach allows partners to use the same wrapper for all resources exposed by the new generation of Expedia Partner Services like the EPS-Product and EPS-Promo services. 

Consider the following code in Java:
```Java
public class ResponseWrapperDTO<T> implements Serializable {
    private T entity;
    private List<ErrorDTO> errors;
}
```
Entities can be ProductDTO/RatePlanDTO/RoomTypeDTO/PropertyDTO etc.
Simple entity response:
```JSON
{
  "entity": {
    "resourceId": 123,
    ...
  }
}
```
If a response doesn’t contain an Entity, it will contain Errors:
```JSON
{
  "errors": [
    {
      "code": 1000,
      "message": "Access denied: your account is not authorized to manage this property."
    }
  ]
}
```
## Entity vs Errors
Entity and errors are in the same wrapper because most frameworks will de-serialize responses automatically, but require a target type to which the response will be de-serialized.
Both successful and unsuccessful responses are returned by the same DTO, but can have either entity or errors, never both.
A Java implementation to handle this, using Spring’s RestTemplate, could look like this:
```Java
   ResponseEntity<ResponseWrapperDTO<ProductDTO>> response = restTemplate.exchange(
            "url",
            HttpMethod.POST,
            entity,
            new ParameterizedTypeReference<ResponseWrapperDTO<ProductDTO>>() {});
```
# Understanding Cancellation & Change Policy
The Cancellation & Change Policy is applicable when a customer either wants to cancel a reservation or when he makes a change to a reservation that would cause the rate to be different. Changes impacting the reservation rate include: a change of room type, rate plan, occupancy or dates. The Cancellation & Change Policy is defined with the following attributes in the Expedia system:

| Attribute Name | Description |
| -------------- | ----------- |
| Deadline | Penalty window defined in hours. Hours are relative to checkin date and the property's cancellation time (property level configuration that is available in read-only mode under the property resource). Min 0, max 999 hours. |
| Penalty | Value should match one of the defined values. No other values can be accepted by the API: - None - 1stNightRoomAndTax - 2NightsRoomAndTax - 10PercentCostOfStay - 20PercentCostOfStay - 30PercentCostOfStay - 40PercentCostOfStay - 50PercentCostOfStay - 60PercentCostOfStay - 70PercentCostOfStay - 80PercentCostOfStay - 90PercentCostOfStay - FullCostOfStay |
| Amount | Flat amount that can be charged if customer cancels. |

Cancellation and change policy is optional when creating a new rate plan.
- If provided, please indicate the cancellation policy values including the deadline for cancellation in hours, and the cancellation penalty.
- If no cancellation policy is provided in a create rate plan request, we will default to select the one which already exists, is refundable, and was most recently used by a standalone active rate plan.
- If no cancellation policy can be found due to not having any active standalone rate plans, we will default to a standard cancellation policy where the cancellation deadline is set to 24h from guest arrival, the penalty for cancelling inside this deadline is one night room and tax, and there is no penalty for cancelling outside of this deadline. 

When providing a cancel policy, partners can provide one or more defaultPenalties object.
- At least one defaultPenalty must be provided, with a deadline set to 0.
- If no other default penalty is provided, there will be a single strategy applied, defined by that defaultPenalty per stay fee and amount.
- In addition to the default penalty with a deadline set at 0, only one additional defaultPenalty can be provided (for a total of 2). 
- If a second penalty is provided, its deadline must be greater than 0, and less than 1000.


**Example 1** : Considering the following policy: 
- If a customer cancels between 24h or less before property's cancellation time, he pays for one night.
- If a customer cancels more than 24h before property's cancellation time, he pays no penalty.

To reflect such terms, a partner should send:
```JSON
  "cancelPolicy": {
    "defaultPenalties": [
      {
        "deadline": 0,
        "perStayFee": "1stNightRoomAndTax",
        "amount": 0.0
      }, {
        "deadline": 24,
        "perStayFee": "None",
        "amount": 0.0
      }
    ]
  }
```

**Example 2** : variation of the above example, where 
- cancellations within 24h of property cancellation time deadline should be charged 1 night room and tax
- cancellations further out should incur a 5 unit of currency penalty (for example 5 GBP for a London, UK property, assuming property rate acquisition type is SellLAR)

To reflect such terms, a partner should send:
```JSON
  "cancelPolicy": {
    "defaultPenalties": [
      {
        "deadline": 0,
        "perStayFee": "1stNightRoomAndTax",
        "amount": 0.0
      }, {
        "deadline": 24,
        "perStayFee": "None",
        "amount": 5.0
      }
    ]
  }
```
  
**Example 3** : if a policy is non-refundable, partner should send:
```JSON
  "cancelPolicy": {
    "defaultPenalties": [
      {
        "deadline": 0,
        "perStayFee": "FullCostOfStay",
        "amount": 0.0
      }
    ]
  }
```
